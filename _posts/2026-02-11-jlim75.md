---
layout: post
title:  "Using PCA to visualize spatial patterns in high-dimensional gene expression within coronal kidney section"
author: Jamie Lim
jhed: jlim75
categories: [ HW3 ]
image: homework/hw3/hw3_jlim75.png
featured: false
---

### 1. Describe your figure.
The represented data type is quantitative. I am visualizing the x and y spatial positions of cells in the coronal kidney section (all plots). I am also visualizing PC1 scores per cell (leftmost plot) and mean expression data for genes with the top 10 highest and lowest PC1 loading values (center and rightmost plots).

### 2. Describe the cell-type for your cluster of interest.
I have visualized this quantitative data by using the geometric primitive of points to represent cells within the coronal kidney section (all plots). I have used the visual channel of position along the x- and y-axes to encode the x and y spatial positions, respectively, of these cells (all plots). Furthermore, I have used the visual channel of color saturation on the blue scale to encode the PC1 scores of the cells on the log scale (leftmost plot). I have also used the visual channel of color saturation on the blue scale to encode mean expression data for genes with the top 10 highest and lowest PC1 loading values (center and rightmost plots). Light blue points represent cells with higher PC1 scores/expression levels while dark blue points represent cells with lower PC1 scores/expression levels.

### 3. Code

```r
# Read data
data <- read.csv('C:/Users/jamie/OneDrive - Johns Hopkins/Documents/Genomic Data Visualization/Xenium-IRI-ShamR_matrix.csv.gz')

# Each row represents one cell
# First column represents cell names
# Second and third columns represent x and y spatial positions of cells
# Fourth and beyond columns represent expression of specific genes in cells
data[1:5,1:5]

# Split up spatial data and gene expression data

# Create spatial data frame with second and third columns of old data frame
# Set row names of spatial data frame as first column of old data frame 
pos <- data[,c('x','y')]
rownames(pos) <- data[,1]
head(pos)

# Create gene expression data frame with fourth and beyond columns of old data frame
# Set row names of gene expression data frame as first column of old data frame
gexp <- data[,4:ncol(data)]
rownames(gexp) <- data[,1]
gexp[1:5,1:5]

# How many total genes are detected per cell?
# Since rows represent cells, add all gene expression counts for each row
totgexp <- rowSums(gexp)
head(totgexp)

# Cells with highest total gene expression counts
head(sort(totgexp, decreasing = TRUE))

# Cells with lowest total gene expression counts
head(sort(totgexp, decreasing = FALSE))

# Data has high variation in total gene expression counts per cell
# We may have captured different proportions of cell volume, thus affecting total expression counts

# Obtain proportional representation of each gene's expression in each cell
# Normalize by counts per million with pseudo-count of 1 to avoid getting undefined values
# Log-transform makes data more Gaussian
mat <- log10(gexp/totgexp * 1e6 + 1)
head(mat)
newtotgexp <- rowSums(mat)

# Cells with highest total gene expression counts
head(sort(newtotgexp, decreasing = TRUE))

# Cells with lowest total gene expression counts
head(sort(newtotgexp, decreasing = FALSE))

# Variation in data has been reduced

# Identify epithelial cells using Epcam expression above 0
epicells <- rownames(mat)[mat[,'Epcam'] > 0]
head(epicells)

# Subset gene expression and spatial data to epithelial cells only to narrow down our focus
mat_epi <- mat[epicells, ]
head(mat_epi)
pos_epi <- pos[epicells, ]
head(pos_epi)

# Make PCs with default settings
pcs <- prcomp(mat_epi, center = TRUE, scale = FALSE)
df_pcs <- data.frame(pcs$x, pos_epi)
library(ggplot2)
ggplot(df_pcs, aes(x=x, y=y, col=PC1)) + geom_point(size=0.5)

# Choose to visualize data on PC1 and PC2 because they capture the greatest proportion of total variance in data

# Create elbow plot for number of clusters vs. total within-cluster sum of squares
centers <- 1:20
tot_withinss <- numeric(length(centers))

for (i in centers) {
  km <- kmeans(mat_epi, centers = i)
  tot_withinss[i] <- km$tot.withinss
}

plot(centers, tot_withinss, type = "b",
     xlab = "Number of centers (k)",
     ylab = "Total within-cluster sum of squares",
     main = "Elbow Plot for k-means")

# Variation in total within-cluster sum of squares starts to decrease around cluster 7

# K means clustering
# First set centers to 7 due to the results of the elbow plot, then check plots
# Set seed to any number to keep cluster of interest labeled the same color
set.seed(123)
clusters <- as.factor(kmeans(pcs$x[,1:2], centers=7)$cluster)
df_clusters <- data.frame(pcs$x, pos_epi, clusters)
g1 <- ggplot(df_clusters, aes(x=x, y=y, col=clusters)) + geom_point(size=0.9) + labs(x='Spatial x position', y='Spatial y position', title='Cluster of interest (green) in physical space', color='Clusters') + theme_classic()
g4 <- ggplot(df_clusters, aes(x=PC1, y=PC2, col=clusters)) + geom_point(size=0.9) + labs(x='PC1', y="PC2", title='Cluster of interest (green) in reduced dimensional space', color='Clusters') + theme_classic()

# Compare gene expression in cells of cluster of interest vs. cells of all other clusters
clusterofinterest <- names(clusters)[clusters == 3]
othercells <- names(clusters)[clusters != 3]

# Loop to compare expression of all genes in cluster of interest vs. other clusters
out <- sapply(colnames(mat_epi), function(gene) {
  x1 <- mat_epi[clusterofinterest, gene]
  x2 <- mat_epi[othercells, gene]
  wilcox.test(x1, x2, alternative = 'greater')$p.value
})
out

# See which genes have p values of 0 and thus are highly upregulated in cluster of interest compared to all other clusters
out[out==0]

# Aqp2 has p value of 0 and serves as marker for kidney collecting duct principal cells (type of epithelial cell)
df_aqp2 <- data.frame(pcs$x, pos_epi, clusters, gene=mat_epi[,'Aqp2'])
g6 <- ggplot(df_aqp2, aes(x=PC1, y=PC2, col=gene)) + geom_point(size=0.9) + labs(x='PC1', y="PC2", title='Expression of Aqp2 in reduced dimensional space', color = "Expression") + theme_classic()
g3 <- ggplot(df_aqp2, aes(x=x, y=y, col=gene)) + geom_point(size=0.9) + labs(x='Spatial x position', y="Spatial y position", title='Expression of Aqp2 in physical space', color = "Expression") + theme_classic()

# Scnn1g has p value of 0 and serves as marker for kidney collecting duct principal cells (type of epithelial cell)
df_scnn1g <- data.frame(pcs$x, pos_epi, clusters, gene=mat_epi[,'Scnn1g'])
# ggplot(df_scnn1g, aes(x=PC1, y=PC2, col=gene)) + geom_point(cex=0.5, alpha=0.5) + labs(color = "Scnn1g")
# ggplot(df_scnn1g, aes(x=x, y=y, col=gene)) + geom_point(size=0.5) + labs(color = "Scnn1g")

# Bmpr1b has p value of 0 and serves as marker for kidney collecting duct principal cells (type of epithelial cell)
df_bmpr1b <- data.frame(pcs$x, pos_epi, clusters, gene=mat_epi[,'Bmpr1b'])
# ggplot(df_bmpr1b, aes(x=PC1, y=PC2, col=gene)) + geom_point(cex=0.5, alpha=0.5) + labs(color = "Bmpr1b")
# ggplot(df_bmpr1b, aes(x=x, y=y, col=gene)) + geom_point(size=0.5) + labs(color = "Bmpr1b")

# Make combined dataframe for all three genes
df_all <- data.frame(
  pcs$x,
  pos_epi,
  clusters,
  Aqp2   = mat_epi[,'Aqp2'],
  Scnn1g = mat_epi[,'Scnn1g'],
  Bmpr1b = mat_epi[,'Bmpr1b']
)

# Convert to long format
library(tidyr)

df_long <- pivot_longer(df_all,
                        cols = c(Aqp2, Scnn1g, Bmpr1b),
                        names_to = "gene",
                        values_to = "expression")

# Plot all genes on same axes with different colors
# Use smaller sized points to better visualize co-localization of all three genes/colors
g5 <- ggplot(df_long, aes(x = PC1, y = PC2, col = gene, alpha = expression)) +
  geom_point(size = 0.6, shape = 16) +
  labs(x='PC1', y='PC2', title='Expression of Aqp2, Bmpr1b, and Scnn1g in reduced dimensional space', color = "Gene", alpha='Expression') +
  scale_alpha_continuous(range = c(0, 1), limits = c(0, 3)) +
  theme_classic()

g2 <- ggplot(df_long, aes(x = x, y = y, col = gene, alpha = expression)) +
  geom_point(size = 0.6, shape = 16) +
  labs(x='Spatial x position', y='Spatial y position', title='Expression of Aqp2, Bmpr1b, and Scnn1g in physical space', color = "Gene", alpha='Expression') +
  scale_alpha_continuous(range = c(0, 1), limits = c(0, 3)) +
  theme_classic()

# Create and save multi-panel data visualization
library(patchwork)
panel <- g1 + g2 + g3 + g4 + g5 + g6

ggsave("hw3_jlim75.png", panel,
       width = 18, height = 12, dpi = 300)

# Prompts to ChatGPT
# How can I create a subset of cells from my data based on the expression of an epithelial cell marker called Epcam?
# How can I write a for-loop in R that calculates tot_withinss for centers 1 through 20 so that I can create an elbow plot using these numbers?
# How can I keep my cluster of interest labeled the same color no matter how many times I re-create the plots by re-running ggplot?
# How can I combine three different data frames into one data frame for the purposes of overlaying data onto one plot?
# Now that I have one combined data frame with three different genes, how can I visualize the expression of these genes onto one plot with PC1 and PC2 axes?
# How can I set the scale for gene expression levels so that an expression level of 0 corresponds with a completely transparent point?
# How can I increase the dimensions of my saved png file so that the six graphs are not squished together?
```
