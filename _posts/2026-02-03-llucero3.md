---
layout: post
title:  "Visualizing Spatial Gene Expression with PCA and tSNE"
author: Lesly Lucero
jhed: llucero
categories: [ HW2 ]
image: homework/hw2/hw2_llucero3.png
featured: false
---

### 1. How do the gene loadings on the first PC relate to features of the genes such as its mean or variance?

The loadings of genes on the first principal component are primarily determined by gene variance rather than mean expression. Because the data are centered prior to PCA, average gene expression levels do not directly influence the loadings. Instead, genes that exhibit high variability across spatial spots and covary with other genes with low or near-constant expression show minimal contribution and have loadings near zero. The sign of a loading reflects the direction of association with PC1 scores, indicating whether a gene increases or decreases along that dominant axis of variation.

### 2. How do the genes with high versus low loadings relate to each other? How are they patterned relative to each other in the tissue?

Genes with high loading on the first principal component tend to be related to each other because they vary together across the tissue. If multiple genes have high loadings with the same sign, they are usually expressed in the same regions of the tissue, showing similar spatial patterns. Genes with opposite loading signs tend to show opposite patterns, where one is highly expressed in regions where the other is low. In contrast, genes with low loadings do not strongly follow the main spatial trend captured by PC1 and are more evenly expressed or vary in smaller, less organized ways across the tissue.

### 3. How do tSNE coordinates change as you increase or decrease the number of PCs?

When you use fewer PCs as input to t-SNE, the coordinates tend to show smoother, more compact clusters because t-SNE is mostly capturing the strongest, global patterns in the data. As you increase the number of PCs, more variation and noise are included, which can cause the t-SNE coordinates to spread out, break into smaller clusters, or show more fragmented structure. This means that changing the number of PCs can noticeably shift the positions of points in t-SNE space, even though the underlying data stay the same. Overall, fewer PCs emphasize broad trends, while more PCs highlight finer-scale differences.

### 4. How do tSNE coordinates change as you increase or decrease the perplexity?

When perplexity is low, t-SNE focuses more on very local relationships, so the coordinates tend to break into many small, tight clusters and nearby points strongly influence each other. As perplexity increases, t-SNE considers a larger neighborhood around each point, which usually makes the coordinates look smoother and more globally organized, with fewer but larger clusters. Changing the perplexity can shift the relative positions of clusters and sometimes even merge or split them. Overall, low perplexity emphasizes local structure, while high perplexity emphasizes broader patterns in the data.

Attribution to external resources reference: Chat GPT was used to help troubleshoot R errors, suggest strategies for dimensionality reduction visualization.

### 5. Code (paste your code in between the \`\`\` symbols)

``` r
library(ggplot2)

# ---- Load data ----
data <- read.csv("~/Desktop/Visium-IRI-ShamR_matrix.csv.gz")

# ---- Spatial coordinates ----
pos <- data[, c("x", "y")]

# ---- Gene expression ----
gexp <- data[, sapply(data, is.numeric)]
gexp <- gexp[, !(colnames(gexp) %in% c("x", "y"))]

# ---- Remove constant/zero-variance genes ----
keep_var <- apply(gexp, 2, sd, na.rm = TRUE) > 0
gexp <- gexp[, keep_var]


# ---- PCA  ----
pca <- prcomp(gexp, center = TRUE, scale. = TRUE)

# ---- Data for plotting ----
df <- data.frame(
  x = pos$x,
  y = pos$y,
  PC1 = pca$x[, 1],
  PC2 = pca$x[, 2]
)

# ---- 2-panel spatial PCA visualization ----
p1 <- ggplot(df, aes(x, y, color = PC1)) +
  geom_point(size = 0.5) +
  scale_color_viridis_c() +
  coord_fixed() +
  theme_minimal() +
  labs(title = "Spatial pattern of PC1")

p2 <- ggplot(df, aes(x, y, color = PC2)) +
  geom_point(size = 0.5) +
  scale_color_viridis_c() +
  coord_fixed() +
  theme_minimal() +
  labs(title = "Spatial pattern of PC2")

library(patchwork)
p1 + p2

```
